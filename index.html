<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Channel Data Display</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .channel {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .channel img {
            max-width: 100px;
            margin-right: 15px;
        }
    </style>
</head>
<body>

    <h1>Channel Data</h1>
    <div id="channel-container">Loading channels...</div>

    <script>
        // Converts a hex string to a Base64 string
        const hexToBase64 = (hex) => {
            return btoa(String.fromCharCode(...hex.match(/\w{2}/g).map(h => parseInt(h, 16))));
        };

        // Function to fetch data from the provided URL
        const fetchData = async (url) => {
            try {
                console.log(`Fetching data from: ${url}`);
                const response = await axios.get(url);
                console.log(`Data fetched successfully from ${url}`);
                return response.data;
            } catch (error) {
                console.error('Request failed:', error.message);
                throw error;
            }
        };

        // Function to fetch channel data and format it
        const fetchChannelData = async () => {
            try {
                console.log('Fetching channel data...');
                const response = await fetchData("https://rahuketu.rf.gd");

                const channels = response?.data || [];
                console.log(`Channels data fetched successfully. Total channels: ${channels.length}`);

                return channels.map(channel => {
                    // Create clearkey data from licence1 and licence2
                    let clearkeyData = null;
                    if (channel.licence1 && channel.licence2) {
                        const base64Licence1 = hexToBase64(channel.licence1);
                        const base64Licence2 = hexToBase64(channel.licence2);
                        if (base64Licence1 && base64Licence2) {
                            clearkeyData = {
                                keys: [{
                                    kty: "oct",
                                    k: base64Licence2,
                                    kid: base64Licence1
                                }],
                                type: "temporary"
                            };
                            console.log(`Clearkey data created for channel ${channel.id}: ${JSON.stringify(clearkeyData)}`);
                        }
                    }

                    return {
                        id: channel.id,
                        name: channel.title,
                        genre: channel.genre || null,
                        logo: channel.logo,
                        stream_url: channel.initialUrl,
                        pssh: channel.psshSet || null,
                        clearkey: clearkeyData ? JSON.stringify(clearkeyData) : null
                    };
                });
            } catch (error) {
                console.error('Fetch error:', error.message);
                return [];
            }
        };

        // Function to display fetched data on the webpage
        const displayChannels = async () => {
            const channelContainer = document.getElementById('channel-container');
            const channels = await fetchChannelData();

            if (channels.length === 0) {
                channelContainer.innerHTML = 'No channels available.';
                return;
            }

            // Clear the container
            channelContainer.innerHTML = '';

            // Loop through channels and display them
            channels.forEach(channel => {
                const channelDiv = document.createElement('div');
                channelDiv.classList.add('channel');

                channelDiv.innerHTML = `
                    <div>
                        <img src="${channel.logo}" alt="${channel.name} Logo">
                        <strong>${channel.name}</strong>
                    </div>
                    <div>Genre: ${channel.genre}</div>
                    <div>Stream URL: <a href="${channel.stream_url}" target="_blank">Watch</a></div>
                    <div>PSSH: ${channel.pssh}</div>
                    <div>Clearkey: ${channel.clearkey ? channel.clearkey : 'N/A'}</div>
                `;

                channelContainer.appendChild(channelDiv);
            });
        };

        // Load and display channels when the page loads
        window.onload = displayChannels;
    </script>
</body>
</html>
